var fs,rationingList,topojson,geoblock,usedblock,hash,i$,len$,rule,j$,ref$,len1$,geo,key$,townOnly,k,haveVillage,p,key,that,datasrc;for(fs=require("fs"),rationingList=fs.readFileSync("list.csv").toString().split("\n"),rationingList=rationingList.slice(1,rationingList.length).filter(function(e){return e}).map(function(e){return e.split(",")}),topojson={village:JSON.parse(fs.readFileSync("village.json").toString()),town:JSON.parse(fs.readFileSync("town.json").toString())},geoblock={village:topojson.village.objects["10402村里界(WGS84經緯度)"].geometries,town:topojson.town.objects["鄉鎮界(經緯度)1031225_big5"].geometries},usedblock={village:[],town:[]},hash={},i$=0,len$=rationingList.length;len$>i$;++i$)if(rule=rationingList[i$],"_"===rule[1])for(j$=0,len1$=(ref$=geoblock.town).length;len1$>j$;++j$)geo=ref$[j$],geo.properties.C_Name===rule[0]&&((hash[key$=rule[0]+"/"+geo.properties.T_Name]||(hash[key$]={}))._=rule);else(hash[key$=rule[0]+"/"+rule[1]]||(hash[key$]={}))[rule[2]]=rule;for(townOnly=function(){var e=[];for(k in hash)e.push(k);return e}().filter(function(e){var o;return 1===function(){var t=[];for(o in hash[e])t.push(o);return t}().length&&hash[e]._}),console.log(townOnly),haveVillage=function(){var e=[];for(k in hash)e.push(k);return e}().filter(function(e){var o;return function(){var t=[];for(o in hash[e])t.push(o);return t}().length>1||!hash[e]._}),console.log(">>>",haveVillage),i$=0,len$=(ref$=geoblock.town).length;len$>i$;++i$)geo=ref$[i$],p=geo.properties,key=p.C_Name+"/"+p.T_Name,townOnly.indexOf(key)>=0&&(p.category=hash[key]._[3],(that=hash[key]._[4])&&(p.comment||(p.comment=[])).push(that),usedblock.town.push(geo));for(i$=0,len$=(ref$=geoblock.village).length;len$>i$;++i$)if(geo=ref$[i$],p=geo.properties,key=p.C_Name+"/"+p.T_Name,haveVillage.indexOf(key)>=0){if(datasrc=(that=hash[key][p.V_Name])?that:hash[key]._,!datasrc)continue;p.category=datasrc[3],(that=datasrc[4])&&(p.comment||(p.comment=[])).push(that),usedblock.village.push(geo)}topojson.village.objects["10402村里界(WGS84經緯度)"].geometries=usedblock.village,topojson.town.objects["鄉鎮界(經緯度)1031225_big5"].geometries=usedblock.town,fs.writeFileSync("geodata.json",JSON.stringify(topojson));